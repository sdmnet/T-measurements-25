<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>أداة القياسات الحقلية</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.29/"></script>
<style>
html, body, #viewDiv { height: 100%; margin:0; padding:0; font-family: sans-serif; }
#buttonsContainer { position: absolute; bottom: 60px; left: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 99; }
.action-button { background-color: #0078d4; border: none; color: white; padding: 10px 18px; font-size: 14px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: 0.3s; }
.action-button:hover { background-color: #005ea0; }
.delete-button { background-color: #e63946; }
.delete-button:hover { background-color: #c1121f; }
#myLocationBtn { position: absolute; top: 15px; right: 15px; background:white; border:1px solid #ccc; border-radius:50%; width:40px; height:40px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:99; display:flex; align-items:center; justify-content:center; }
#myLocationBtn:hover { background-color: #e8f0fe; }
#recordsTableContainer { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 90%; max-height: 150px; overflow-y: auto; background: rgba(255,255,255,0.95); border-top-left-radius:8px; border-top-right-radius:8px; box-shadow: 0 -2px 6px rgba(0,0,0,0.2); font-size:13px; z-index: 99; }
#recordsTableHeader { cursor: pointer; background:#ddd; padding:4px; text-align:center; }
#recordsTableContainer table { width: 100%; border-collapse: collapse; }
#recordsTableContainer th, td { border: 1px solid #ccc; padding: 4px 6px; text-align:center; }
#recordsTableContainer th { background-color: #f0f0f0; font-weight:600; }
</style>
</head>
<body>
<div id="viewDiv"></div>
<button id="myLocationBtn" title="اذهب إلى موقعي">📍</button>

<div id="buttonsContainer">
  <button id="sendDataBtn" class="action-button">إرسال البيانات</button>
  <button id="clearDataBtn" class="action-button delete-button">مسح السجلات</button>
</div>

<div id="recordsTableContainer">
  <div id="recordsTableHeader">سجلات القياسات (اضغط للطي/التوسيع)</div>
  <table id="recordsTable">
    <thead>
      <tr><th>ID</th><th>نوع</th><th>مساحة (هكتار)</th><th>إحداثيات</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
require([
  "esri/Map", "esri/views/MapView", "esri/widgets/Sketch",
  "esri/layers/GraphicsLayer", "esri/Graphic", "esri/geometry/geometryEngine",
  "esri/geometry/support/webMercatorUtils"
], function(Map, MapView, Sketch, GraphicsLayer, Graphic, geometryEngine, webMercatorUtils){

  const gLayer = new GraphicsLayer();
  const map = new Map({ basemap: "satellite", layers:[gLayer] });
  const view = new MapView({ container: "viewDiv", map: map, center:[44.0,36.2], zoom:8 });

  const sketch = new Sketch({ layer: gLayer, view: view, creationMode:'update' });
  view.ui.add(sketch, "top-right");

  const localRecords = [];
  const tableBody = document.querySelector('#recordsTable tbody');

  function generateId(){ return 'rec-' + Date.now() + '-' + Math.random().toString(36).slice(2,8); }

  function serializeGeometry(geom){
    if(geom.type==='point'){
      const geo = webMercatorUtils.webMercatorToGeographic(geom);
      return {lat:geo.y, lon:geo.x};
    } else if(geom.type==='polygon'){
      return geom.rings[0].map(p => { 
        const g = webMercatorUtils.webMercatorToGeographic({x:p[0],y:p[1],spatialReference:geom.spatialReference}); 
        return [g.y,g.x]; 
      });
    }
    return null;
  }

  function refreshTable(){
    tableBody.innerHTML = '';
    localRecords.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.id}</td><td>${r.type}</td><td>${r.area_ha?r.area_ha.toFixed(4):''}</td><td>${JSON.stringify(r.coords)}</td>`;
      tableBody.appendChild(tr);
    });
  }

  sketch.on('create', function(event){
    if(event.state==='complete'){
      const geom = event.graphic.geometry;
      let areaHectares=null;
      if(geom.type==='polygon') areaHectares = geometryEngine.geodesicArea(geom,'square-meters')/10000.0;

      const rec={ id: generateId(), type:geom.type, coords:serializeGeometry(geom), area_ha: areaHectares, timestamp: new Date().toISOString() };
      localRecords.push(rec);
      refreshTable();
    }
  });

  document.getElementById('myLocationBtn').addEventListener('click',()=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        view.goTo({center:[lon,lat],zoom:15});
        const myPoint = new Graphic({geometry:{type:'point',latitude:lat,longitude:lon},symbol:{type:'simple-marker',color:'blue',size:'12px'}});
        gLayer.add(myPoint);
      });
    } else alert('Geolocation not supported');
  });

  document.getElementById('sendDataBtn').addEventListener('click',()=>{
    if(localRecords.length===0){ alert('لا توجد سجلات لإرسالها'); return; }
    const scriptURL = 'https://script.google.com/macros/s/AKfycbySQH_U5ygpelW9GWrICoSWhxW-jTt7etz5BAQuNyh1gvDRLxaLEwiSqWU8msYrp4mh/exec';
    
    fetch(scriptURL, { 
      method:'POST', 
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(localRecords)
    })
    .then(res => res.json())
    .then(data => alert('تم الإرسال: ' + data.message))
    .catch(err => alert('خطأ أثناء الإرسال: ' + err));
  });

  document.getElementById('clearDataBtn').addEventListener('click',()=>{
    if(confirm('مسح كافة السجلات؟')){
      gLayer.removeAll();
      localRecords.length=0;
      refreshTable();
    }
  });

  // Toggle table collapse
  const tableHeader = document.getElementById('recordsTableHeader');
  let collapsed=false;
  tableHeader.addEventListener('click',()=>{
    collapsed = !collapsed;
    tableBody.parentElement.style.display = collapsed ? 'none' : 'table';
  });

});
</script>
</body>
</html>

